<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Angry Bird Goku Edici√≥n</title>
  <style>
    body { margin: 0; background: #87CEEB; overflow: hidden; font-family: sans-serif; text-align: center; }
    canvas { background: #87CEEB; display: block; margin: auto; border-bottom: 5px solid #654321; }
    h1 { margin-top: 10px; color: darkgreen; }
    #topBar {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 10px;
    }
    #topBar button, #playButton, #retryButton {
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    #playButton {
      background: green;
      color: white;
      margin-top: 20px;
    }
    #retryButton {
      display: none;
      margin-top: 10px;
      background-color: red;
      color: white;
    }
    #gameCanvas { display: none; }
  </style>
</head>
<body>
<h1 id="levelTitle">Angry Bird Goku Edition</h1>
<div id="topBar" style="display:none;">
  <button onclick="resetGame()">üîÅ Reiniciar Nivel</button>
</div>
<button id="playButton" onclick="startGame()">‚ñ∂Ô∏è Jugar</button>
<canvas id="gameCanvas" width="600" height="400"></canvas>
<button id="retryButton" onclick="resetGame()">üîÅ Volver a Intentar</button>
<audio id="gokuSound" src="https://github.com/JC-004/juego-angry/raw/main/kiko.mp3"></audio>

<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
const retryButton = document.getElementById("retryButton");
const levelTitle = document.getElementById("levelTitle");
const topBar = document.getElementById("topBar");
const playButton = document.getElementById("playButton");
const gokuSound = document.getElementById("gokuSound");

let birds = [];
let pigs = [];
let gravity = 0.5;
let ground = 370;
let aimLine = { active: false, x: 0, y: 0 };
let currentBird = 0;
let gameEnded = false;
let currentLevel = 1;
const maxLevel = 2;
let gokuActive = false;
let gokuY = -100;

function startGame() {
  playButton.style.display = "none";
  canvas.style.display = "block";
  topBar.style.display = "flex";
  initGame();
  requestAnimationFrame(update);
}

function resetGame() {
  gokuSound.pause();
  gokuSound.currentTime = 0;
  birds = [];
  pigs = [];
  currentBird = 0;
  gameEnded = false;
  retryButton.style.display = "none";
  initGame();
}

function initGame() {
  gokuSound.pause();
  gokuSound.currentTime = 0;
  let birdCount = currentLevel === maxLevel ? 1 : 3;
  birds = [];
  pigs = [];
  gokuActive = false;
  gokuY = -100;

  for (let i = 0; i < birdCount; i++) {
    birds.push({
      x: 60,
      y: 300,
      r: 15,
      dx: 0,
      dy: 0,
      launched: false,
      used: false,
      color: currentLevel === maxLevel ? "orange" : "red",
      speed: currentLevel === maxLevel ? 1.5 : 1
    });
  }

  let pigCount = currentLevel === maxLevel ? 5 : 3;
  for (let i = 0; i < pigCount; i++) {
    let col = i % 3;
    let row = Math.floor(i / 3);
    pigs.push({ x: 300 + col * 40, y: 300 - row * 40, r: 10, hit: false });
  }

  aimLine = { active: false, x: 0, y: 0 };
  currentBird = 0;
  gameEnded = false;
  retryButton.style.display = "none";
  levelTitle.textContent = `Nivel ${currentLevel}${currentLevel === maxLevel ? " - GOKU SSJ üî•" : ""}`;
}

canvas.addEventListener("mousedown", e => {
  if (currentBird < birds.length && !birds[currentBird].launched && !gameEnded) {
    const rect = canvas.getBoundingClientRect();
    aimLine.active = true;
    aimLine.x = e.clientX - rect.left;
    aimLine.y = e.clientY - rect.top;
  }
});

canvas.addEventListener("mouseup", e => {
  if (currentBird < birds.length && !birds[currentBird].launched && aimLine.active && !gameEnded) {
    const rect = canvas.getBoundingClientRect();
    let mx = e.clientX - rect.left;
    let my = e.clientY - rect.top;
    let bird = birds[currentBird];
    let forceX = bird.x - mx;
    let forceY = bird.y - my;
    let magnitude = Math.min(Math.sqrt(forceX ** 2 + forceY ** 2), 100);
    let angle = Math.atan2(forceY, forceX);
    bird.dx = Math.cos(angle) * (magnitude * 0.2 * bird.speed);
    bird.dy = Math.sin(angle) * (magnitude * 0.2 * bird.speed);
    bird.launched = true;
    aimLine.active = false;
  }
});

canvas.addEventListener("mousemove", e => {
  if (aimLine.active) {
    const rect = canvas.getBoundingClientRect();
    aimLine.x = e.clientX - rect.left;
    aimLine.y = e.clientY - rect.top;
  }
});

function drawCircle(obj, color) {
  ctx.beginPath();
  ctx.arc(obj.x, obj.y, obj.r, 0, Math.PI * 2);
  ctx.fillStyle = color;
  ctx.fill();
}

function update() {
  if (gameEnded) return;

  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.fillStyle = "#87CEEB";
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  ctx.fillStyle = "#654321";
  ctx.fillRect(0, ground, canvas.width, 5);

  for (let pig of pigs) if (!pig.hit) drawCircle(pig, "green");
  for (let bird of birds) if (!bird.used) drawCircle(bird, bird.color);

  if (currentBird < birds.length && !birds[currentBird].launched && aimLine.active) {
    ctx.beginPath();
    ctx.moveTo(birds[currentBird].x, birds[currentBird].y);
    ctx.lineTo(aimLine.x, aimLine.y);
    ctx.strokeStyle = "black";
    ctx.stroke();
  }

  if (currentBird < birds.length) {
    let bird = birds[currentBird];
    if (bird && bird.launched) {
      bird.dy += gravity;
      bird.x += bird.dx;
      bird.y += bird.dy;

      if (bird.y + bird.r >= ground) {
        bird.y = ground - bird.r;
        bird.dy = 0;
        bird.dx = 0;
        bird.used = true;

        if (currentBird + 1 < birds.length) {
          currentBird++;
        } else {
          gameEnded = true;
          retryButton.style.display = "inline-block";
        }
      }

      for (let pig of pigs) {
        if (!pig.hit) {
          const dist = Math.hypot(bird.x - pig.x, bird.y - pig.y);
          if (dist < bird.r + pig.r) pig.hit = true;
        }
      }
    }
  }

  if (!gameEnded && pigs.every(p => p.hit)) {
    gameEnded = true;
    setTimeout(() => {
      if (currentLevel === maxLevel) {
        gokuSound.play().catch(e => console.log("Error al reproducir sonido Goku:", e));
        alert("üêâ ¬°GOKU SSJ lanza la GENKIDAMA! Los cerdos fueron destruidos. ¬°Victoria total!");
        currentLevel = 1;
        initGame();
      } else {
        currentLevel++;
        initGame();
      }
      gameEnded = false;
    }, 1000);
    return;
  }

  requestAnimationFrame(update);
}
</script>
</body>
</html>