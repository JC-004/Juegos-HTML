<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Perú vs Colombia</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #1a2a1a; /* Verde oscuro selva */
            font-family: 'Courier New', Courier, monospace;
            color: white;
            overflow: hidden;
            touch-action: manipulation; /* Mejora la respuesta táctil sin zoom */
        }
        #gameContainer {
            position: relative;
            border: 4px solid #c4a381; /* Borde tipo madera */
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            overflow: hidden;
        }
        canvas {
            display: block;
            background-image: url('https://www.transparenttextures.com/patterns/natural-paper.png'), linear-gradient(to bottom, #2a4a2a, #1a2a1a);
            background-size: auto, cover;
            cursor: crosshair;
        }
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 10px;
            box-sizing: border-box;
        }
        #top-ui {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #score {
            font-size: 20px;
            text-shadow: 2px 2px 4px black;
            background-color: rgba(0,0,0,0.4);
            padding: 5px 10px;
            border-radius: 5px;
        }
        #pauseButton {
            pointer-events: all;
            cursor: pointer;
            font-size: 20px;
            background-color: #c4a381;
            color: #1a2a1a;
            border: 2px solid #8c735a;
            border-radius: 5px;
            padding: 5px 10px;
            font-weight: bold;
        }
        #progressBarContainer {
            width: 80%;
            height: 20px;
            background-color: rgba(0,0,0,0.5);
            border: 2px solid #8c735a;
            border-radius: 5px;
            margin: 0 auto;
        }
        #progressBar {
            width: 0%;
            height: 100%;
            background-color: #ffcc00;
            border-radius: 3px;
            transition: width 0.5s ease-in-out;
        }
        #message-box {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 40px;
            border-radius: 10px;
            text-align: center;
            font-size: 24px;
            display: flex; /* Visible por defecto para mensajes iniciales */
            flex-direction: column;
            gap: 20px;
            width: 80%;
            max-width: 400px;
        }
        #message-box button {
            padding: 10px 20px;
            font-size: 18px;
            cursor: pointer;
            background-color: #c4a381;
            border: 2px solid #8c735a;
            color: #1a2a1a;
            border-radius: 5px;
            font-weight: bold;
        }
        #controls {
            display: none; /* Se muestra solo en dispositivos táctiles */
            justify-content: space-between;
            width: 100%;
            position: absolute;
            bottom: 20px;
            left: 0;
            padding: 0 20px;
            box-sizing: border-box;
            pointer-events: none;
        }
        .control-btn {
            pointer-events: all;
            width: 70px;
            height: 70px;
            background-color: rgba(196, 163, 129, 0.7);
            border: 3px solid #8c735a;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 30px;
            color: #1a2a1a;
            font-weight: bold;
            user-select: none;
        }
        #shoot-btn {
            width: 90px;
            height: 90px;
            font-size: 20px;
        }
        /* Media query para mostrar controles en pantallas táctiles */
        @media (hover: none) and (pointer: coarse) {
            #controls {
                display: flex;
            }
        }
    </style>
</head>
<body>

<div id="gameContainer">
    <canvas id="gameCanvas"></canvas>
    <div id="ui-layer">
        <div id="top-ui">
            <div id="score">Puntaje: 0</div>
            <button id="pauseButton">||</button>
        </div>
        <div id="progressBarContainer">
            <div id="progressBar"></div>
        </div>
    </div>
    <div id="controls">
        <div class="control-btn" id="left-btn">◀</div>
        <div class="control-btn" id="shoot-btn">FUEGO</div>
        <div class="control-btn" id="right-btn">▶</div>
    </div>
    <div id="message-box">
        <p id="message-text">Cargando recursos...</p>
        <button id="actionButton" style="display: none;">¡Comenzar Misión!</button>
    </div>
</div>
<audio id="shootSound" src="https://raw.githubusercontent.com/JC-004/Juegos-HTML/main/abreme/musica%20de%20fondo/grito.mp3" preload="auto"></audio>

<script>
    // Elementos del DOM
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const scoreEl = document.getElementById('score');
    const messageBox = document.getElementById('message-box');
    const messageText = document.getElementById('message-text');
    const actionButton = document.getElementById('actionButton');
    const pauseButton = document.getElementById('pauseButton');
    const progressBar = document.getElementById('progressBar');
    const shootSound = document.getElementById('shootSound');

    // Controles táctiles
    const leftBtn = document.getElementById('left-btn');
    const rightBtn = document.getElementById('right-btn');
    const shootBtn = document.getElementById('shoot-btn');

    // Estado del juego
    let score = 0;
    const WINNING_SCORE = 250;
    let gameOver = true; // El juego empieza detenido
    let paused = false;
    let animationFrameId;

    // Estado de las teclas para un movimiento robusto
    const keys = {
        right: false,
        left: false
    };

    // Jugador
    const player = {
        width: 50,
        height: 50,
        x: 0,
        y: 0,
        speed: 8,
        dx: 0,
        draw() {
            if(player.img && player.img.complete && player.img.naturalWidth !== 0) {
                ctx.drawImage(player.img, this.x, this.y, this.width, this.height);
            }
        }
    };

    // Recursos
    const assets = {
        playerImg: { src: 'https://raw.githubusercontent.com/JC-004/Juegos-HTML/main/abreme/imagenes/paloma.jpg', img: null },
        enemyImg: { src: 'https://raw.githubusercontent.com/JC-004/Juegos-HTML/main/abreme/imagenes/bolivar.png', img: null }
    };

    // Lógica del juego
    const bullets = [];
    const bulletSpeed = 10;
    const enemies = [];
    let enemySpeed = 2;
    let enemySpawnInterval = 1800;

    // --- FUNCIONES DE INICIALIZACIÓN Y CICLO DE JUEGO ---

    function loadAssets(callback) {
        let assetsLoaded = 0;
        const totalAssets = Object.keys(assets).length;

        for (let key in assets) {
            assets[key].img = new Image();
            assets[key].img.src = assets[key].src;
            assets[key].img.onload = () => {
                assetsLoaded++;
                if (assetsLoaded === totalAssets) {
                    player.img = assets.playerImg.img;
                    callback();
                }
            };
            assets[key].img.onerror = () => {
                console.error(`Error al cargar ${assets[key].src}`);
                messageText.textContent = "Error al cargar recursos. Refresca la página.";
            };
        }
    }

    function main() {
        resizeCanvas();
        messageText.textContent = '¡Defiende la selva!';
        actionButton.textContent = '¡Comenzar Misión!';
        actionButton.style.display = 'block';
        actionButton.onclick = startGame;
    }

    function startGame() {
        // Resetear estado
        gameOver = false;
        paused = false;
        score = 0;
        bullets.length = 0;
        enemies.length = 0;
        enemySpeed = 2;
        enemySpawnInterval = 1800;

        // Posicionar jugador
        player.x = canvas.width / 2 - player.width / 2;
        player.y = canvas.height - player.height - 20;
        player.dx = 0;

        // UI
        messageBox.style.display = 'none';
        pauseButton.textContent = '||';
        updateScore(0);

        // Iniciar ciclos
        if (animationFrameId) cancelAnimationFrame(animationFrameId);
        gameLoop();
        spawnEnemy();
    }

    function gameLoop() {
        if (gameOver || paused) return;

        update();
        draw();

        animationFrameId = requestAnimationFrame(gameLoop);
    }

    // --- FUNCIONES DE ACTUALIZACIÓN (LÓGICA) ---

    function update() {
        movePlayer();
        moveBullets();
        moveEnemies();
        detectCollisions();
    }
    
    function movePlayer() {
        // Establecer velocidad basada en el estado de las teclas
        if (keys.right) {
            player.dx = player.speed;
        } else if (keys.left) {
            player.dx = -player.speed;
        } else {
            player.dx = 0;
        }
        
        // Mover jugador
        player.x += player.dx;

        // Comprobación de límites
        if (player.x < 0) {
            player.x = 0;
        }
        if (player.x + player.width > canvas.width) {
            player.x = canvas.width - player.width;
        }
    }

    function moveBullets() {
        for (let i = bullets.length - 1; i >= 0; i--) {
            bullets[i].y -= bulletSpeed;
            if (bullets[i].y < 0) bullets.splice(i, 1);
        }
    }

    function moveEnemies() {
        for (let i = enemies.length - 1; i >= 0; i--) {
            const enemy = enemies[i];
            enemy.y += enemySpeed;
            if (enemy.y + enemy.height > canvas.height) {
                endGame(false);
                break;
            }
        }
    }

    function detectCollisions() {
        for (let i = bullets.length - 1; i >= 0; i--) {
            for (let j = enemies.length - 1; j >= 0; j--) {
                if (
                    bullets[i] && enemies[j] &&
                    bullets[i].x < enemies[j].x + enemies[j].width &&
                    bullets[i].x + bullets[i].width > enemies[j].x &&
                    bullets[i].y < enemies[j].y + enemies[j].height &&
                    bullets[i].y + bullets[i].height > enemies[j].y
                ) {
                    shootSound.currentTime = 0;
                    shootSound.play().catch(e => console.log("El usuario debe interactuar para reproducir sonido."));
                    
                    enemies.splice(j, 1);
                    bullets.splice(i, 1);
                    updateScore(10);
                    break; 
                }
            }
        }
    }

    function spawnEnemy() {
        if (gameOver || paused) return;
        const size = 50;
        enemies.push({
            x: Math.random() * (canvas.width - size),
            y: -size,
            width: size,
            height: size,
        });
        
        if (enemySpawnInterval > 500) enemySpawnInterval -= 15;
        if (enemySpeed < 5) enemySpeed += 0.02;

        setTimeout(spawnEnemy, enemySpawnInterval);
    }

    // --- FUNCIONES DE DIBUJADO ---

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawJungle();
        player.draw();
        drawBullets();
        drawEnemies();
    }

    function drawJungle() {
        ctx.fillStyle = '#5c3d21';
        ctx.fillRect(canvas.width * 0.1, canvas.height * 0.4, 20, canvas.height * 0.6);
        ctx.fillRect(canvas.width * 0.8, canvas.height * 0.2, 30, canvas.height * 0.8);
        ctx.fillStyle = 'rgba(26, 42, 26, 0.8)';
        ctx.beginPath();
        ctx.arc(canvas.width * 0.1 + 10, canvas.height * 0.4, 60, 0, Math.PI * 2);
        ctx.fill();
        ctx.beginPath();
        ctx.arc(canvas.width * 0.8 + 15, canvas.height * 0.2, 80, 0, Math.PI * 2);
        ctx.fill();
    }

    function drawBullets() {
        ctx.fillStyle = '#ffcc00';
        bullets.forEach(b => ctx.fillRect(b.x, b.y, b.width, b.height));
    }

    function drawEnemies() {
        if(assets.enemyImg.img.complete && assets.enemyImg.img.naturalWidth !== 0){
            enemies.forEach(e => ctx.drawImage(assets.enemyImg.img, e.x, e.y, e.width, e.height));
        }
    }

    // --- FUNCIONES DE UTILIDAD Y UI ---

    function shoot() {
        if (gameOver || paused) return;
        bullets.push({ x: player.x + player.width / 2 - 2.5, y: player.y, width: 5, height: 10 });
    }
    
    function updateScore(points) {
        if (points === 0) score = 0;
        else score += points;
        scoreEl.textContent = `Puntaje: ${score}`;
        const progressPercentage = (score / WINNING_SCORE) * 100;
        progressBar.style.width = `${Math.min(progressPercentage, 100)}%`;

        if (score >= WINNING_SCORE) {
            endGame(true);
        }
    }

    function endGame(isWin) {
        if(gameOver) return;
        gameOver = true;
        cancelAnimationFrame(animationFrameId);
        
        messageText.textContent = isWin ? '¡VICTORIA! ¡Has defendido la posición!' : 'FIN DEL JUEGO. El enemigo ha avanzado.';
        actionButton.textContent = 'Jugar de Nuevo';
        actionButton.style.display = 'block';
        messageBox.style.display = 'flex';
    }

    function togglePause() {
        if (gameOver) return;
        paused = !paused;
        if (paused) {
            messageText.textContent = "PAUSA";
            actionButton.style.display = 'none';
            messageBox.style.display = 'flex';
            pauseButton.textContent = '▶';
            cancelAnimationFrame(animationFrameId);
        } else {
            messageBox.style.display = 'none';
            pauseButton.textContent = '||';
            gameLoop();
            spawnEnemy(); // CORRECCIÓN: Reinicia el ciclo de aparición de enemigos
        }
    }
    
    function resizeCanvas() {
        const container = document.getElementById('gameContainer');
        const maxWidth = window.innerWidth;
        const maxHeight = window.innerHeight;
        
        let width = Math.min(maxWidth, 800);
        let height = Math.min(maxHeight, 600);

        if (window.innerWidth < 768) {
             width = window.innerWidth;
             height = window.innerHeight * 0.85;
        }

        canvas.width = width;
        canvas.height = height;
        container.style.width = `${width}px`;
        container.style.height = `${height}px`;
        
        if(!gameOver) {
            player.y = canvas.height - player.height - 20;
        }
    }

    // --- EVENT LISTENERS ---
    
    window.addEventListener('resize', resizeCanvas);
    document.addEventListener('keydown', e => {
        const key = e.key.toLowerCase();
        if (key === 'arrowright' || key === 'd') keys.right = true;
        else if (key === 'arrowleft' || key === 'a') keys.left = true;
        else if (e.key === ' ') { e.preventDefault(); shoot(); }
        else if (key === 'p') togglePause();
    });
    document.addEventListener('keyup', e => {
        const key = e.key.toLowerCase();
        if (key === 'arrowright' || key === 'd') keys.right = false;
        else if (key === 'arrowleft' || key === 'a') keys.left = false;
    });
    pauseButton.addEventListener('click', togglePause);

    // Controles táctiles
    leftBtn.addEventListener('touchstart', e => { e.preventDefault(); keys.left = true; });
    leftBtn.addEventListener('touchend', e => { e.preventDefault(); keys.left = false; });
    rightBtn.addEventListener('touchstart', e => { e.preventDefault(); keys.right = true; });
    rightBtn.addEventListener('touchend', e => { e.preventDefault(); keys.right = false; });
    shootBtn.addEventListener('touchstart', e => { e.preventDefault(); shoot(); });
    
    // Iniciar todo
    window.onload = () => {
        loadAssets(main);
    };

</script>
</body>
</html>
