<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Demo de Juego 3D Estilo GTA</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Arial', sans-serif; }
        canvas { display: block; }
        #info {
            position: absolute;
            top: 10px;
            width: 100%;
            text-align: center;
            z-index: 100;
            display:block;
            color: white;
            background-color: rgba(0,0,0,0.5);
            padding: 10px;
            border-radius: 10px;
            max-width: 400px;
            left: 50%;
            transform: translateX(-50%);
        }
        #crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 10px;
            height: 10px;
            border: 2px solid white;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            mix-blend-mode: difference;
        }
    </style>
</head>
<body>
    <div id="info">
        Usa WASD para moverte, el Ratón para mirar.<br>
        Presiona 'F' cerca de un coche para entrar/salir.<br>
        Haz Clic para disparar.
    </div>
    <div id="crosshair"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        // ====================================================================
        // CONFIGURACIÓN BÁSICA DE LA ESCENA
        // ====================================================================

        let scene, camera, renderer;
        let player, cars = [], bullets = [];
        let keys = {};
        const clock = new THREE.Clock();

        // Estado del jugador
        let isInCar = false;
        let currentCar = null; // El coche que el jugador está conduciendo
        let playerSpeed = 10.0;
        let carSpeed = 25.0;
        let turnSpeed = 2.0;

        // Configuración de la cámara y el ratón
        let cameraOffset = new THREE.Vector3(0, 6, 12);
        let pitch = 0, yaw = 0;

        function init() {
            // Escena
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87ceeb); // Cielo azul claro
            scene.fog = new THREE.Fog(0x87ceeb, 0, 200);

            // Cámara
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 5, 15);

            // Renderizador
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.body.appendChild(renderer.domElement);

            // Luces
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);

            const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
            dirLight.position.set(-30, 50, -30);
            dirLight.castShadow = true;
            dirLight.shadow.camera.top = 50;
            dirLight.shadow.camera.bottom = -50;
            dirLight.shadow.camera.left = -50;
            dirLight.shadow.camera.right = 50;
            dirLight.shadow.camera.near = 0.1;
            dirLight.shadow.camera.far = 200;
            scene.add(dirLight);

            // ====================================================================
            // CREACIÓN DE OBJETOS DEL JUEGO
            // ====================================================================

            // Suelo
            const groundGeometry = new THREE.PlaneGeometry(500, 500);
            const groundMaterial = new THREE.MeshLambertMaterial({ color: 0x555555 });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.receiveShadow = true;
            scene.add(ground);

            // Jugador (con una "skin" básica)
            createPlayer();
            
            // Coches (múltiples coches)
            for (let i = 0; i < 15; i++) {
                createCar();
            }

            // Edificios (cajas aleatorias)
            const buildingGeometry = new THREE.BoxGeometry(1, 1, 1);
            for (let i = 0; i < 100; i++) {
                const buildingMaterial = new THREE.MeshLambertMaterial({ color: Math.random() * 0xffffff });
                const building = new THREE.Mesh(buildingGeometry, buildingMaterial);
                building.position.x = Math.random() * 400 - 200;
                building.position.z = Math.random() * 400 - 200;
                building.scale.x = Math.random() * 10 + 5;
                building.scale.z = Math.random() * 10 + 5;
                building.scale.y = Math.random() * 30 + 10;
                building.position.y = building.scale.y / 2;
                building.castShadow = true;
                building.receiveShadow = true;
                scene.add(building);
            }

            // ====================================================================
            // MANEJO DE ENTRADAS (TECLADO Y RATÓN)
            // ====================================================================

            document.addEventListener('keydown', (event) => keys[event.key.toLowerCase()] = true);
            document.addEventListener('keyup', (event) => keys[event.key.toLowerCase()] = false);

            document.body.addEventListener('click', () => {
                document.body.requestPointerLock();
            });
            
            document.addEventListener('mousemove', (event) => {
                if (document.pointerLockElement === document.body) {
                    yaw -= event.movementX * 0.002;
                    pitch -= event.movementY * 0.002;
                    pitch = Math.max(-Math.PI / 2 + 0.1, Math.min(Math.PI / 2 - 0.1, pitch));
                }
            });

            document.addEventListener('mousedown', (event) => {
                if (event.button === 0 && !isInCar) {
                    shoot();
                }
            });

            window.addEventListener('resize', onWindowResize, false);
            animate();
        }
        
        // ====================================================================
        // FUNCIONES DE CREACIÓN DE OBJETOS
        // ====================================================================
        
        function createPlayer() {
            // CORRECCIÓN: Se arreglaron los valores de color hexadecimal inválidos.
            const head = new THREE.Mesh(
                new THREE.BoxGeometry(0.5, 0.5, 0.5),
                new THREE.MeshLambertMaterial({ color: 0xF2D5BC })
            );
            head.position.y = 1.75;

            const body = new THREE.Mesh(
                new THREE.BoxGeometry(1, 1.5, 0.5),
                new THREE.MeshLambertMaterial({ color: 0x0000FF })
            );
            body.position.y = 0.75;
            
            player = new THREE.Group();
            player.add(head);
            player.add(body);
            
            player.position.set(0, 0, 10);
            player.castShadow = true;
            scene.add(player);
        }

        function createCar() {
            const carBodyGeo = new THREE.BoxGeometry(2, 1, 4);
            const carBodyMat = new THREE.MeshLambertMaterial({ color: Math.random() * 0xffffff });
            const carBody = new THREE.Mesh(carBodyGeo, carBodyMat);
            carBody.position.y = 0.5;

            const carCabinGeo = new THREE.BoxGeometry(1.8, 0.8, 2);
            const carCabinMat = new THREE.MeshLambertMaterial({ color: 0x333333 });
            const carCabin = new THREE.Mesh(carCabinGeo, carCabinMat);
            carCabin.position.y = 1.4;
            carCabin.position.z = -0.5;

            const car = new THREE.Group();
            car.add(carBody);
            car.add(carCabin);
            
            car.position.set(
                Math.random() * 200 - 100,
                0,
                Math.random() * 200 - 100
            );
            car.rotation.y = Math.random() * Math.PI * 2;

            car.castShadow = true;
            scene.add(car);
            cars.push(car);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // ====================================================================
        // LÓGICA DEL JUEGO
        // ====================================================================

        function animate() {
            requestAnimationFrame(animate);
            const delta = clock.getDelta();

            handleControls(delta);
            updateBullets(delta);
            updateCamera();

            renderer.render(scene, camera);
        }

        function handleControls(delta) {
            // Lógica para entrar/salir del coche
            if (keys['f']) {
                if (!isInCar) {
                    let closestCar = null;
                    let minDistance = 5; // Distancia máxima para poder entrar
                    cars.forEach(car => {
                        const distance = player.position.distanceTo(car.position);
                        if (distance < minDistance) {
                            minDistance = distance;
                            closestCar = car;
                        }
                    });

                    if (closestCar) {
                        isInCar = true;
                        currentCar = closestCar;
                        player.visible = false;
                    }
                } else {
                    isInCar = false;
                    player.position.copy(currentCar.position);
                    player.position.x += 3; // Colocar al jugador al lado del coche
                    player.visible = true;
                    currentCar = null;
                }
                keys['f'] = false; // Evitar repetición
            }

            const controllableObject = isInCar ? currentCar : player;
            const speed = isInCar ? carSpeed : playerSpeed;

            // Movimiento
            if (keys['w']) controllableObject.translateZ(-speed * delta);
            if (keys['s']) controllableObject.translateZ(speed * delta);
            
            // Rotación
            if (isInCar) {
                 if (keys['a']) controllableObject.rotation.y += turnSpeed * delta;
                 if (keys['d']) controllableObject.rotation.y -= turnSpeed * delta;
            } else {
                 if (keys['a']) controllableObject.translateX(-speed * delta * 0.5);
                 if (keys['d']) controllableObject.translateX(speed * delta * 0.5);
                 player.rotation.y = yaw;
            }
        }

        function updateCamera() {
             const target = isInCar ? currentCar : player;
             
             const cameraRotation = new THREE.Quaternion();
             cameraRotation.setFromEuler(new THREE.Euler(pitch, yaw, 0, 'YXZ'));
             
             const desiredPosition = target.position.clone().add(cameraOffset.clone().applyQuaternion(cameraRotation));
             
             camera.position.lerp(desiredPosition, 0.1);
             camera.lookAt(target.position.clone().add(new THREE.Vector3(0, 1, 0)));
        }

        function shoot() {
            const bulletGeometry = new THREE.SphereGeometry(0.1, 8, 8);
            const bulletMaterial = new THREE.MeshBasicMaterial({ color: 0xffff00 });
            const bullet = new THREE.Mesh(bulletGeometry, bulletMaterial);

            bullet.position.copy(player.position);
            bullet.position.y += 1.5;

            const direction = new THREE.Vector3();
            camera.getWorldDirection(direction);
            bullet.velocity = direction.multiplyScalar(150);

            bullets.push(bullet);
            scene.add(bullet);
        }

        function updateBullets(delta) {
            for (let i = bullets.length - 1; i >= 0; i--) {
                const bullet = bullets[i];
                bullet.position.add(bullet.velocity.clone().multiplyScalar(delta));

                if (bullet.position.length() > 300) {
                    scene.remove(bullet);
                    bullets.splice(i, 1);
                }
            }
        }

        // Iniciar todo
        init();
    </script>
</body>
</html>
